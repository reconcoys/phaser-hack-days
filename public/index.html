<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 10</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <script src="//cdn.jsdelivr.net/npm/phaser-matter-collision-plugin"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 1000,
    height:1000,
    backgroundColor: '#333333',
    parent: 'phaser-example',
    physics: {
        default: 'matter',
        matter: {
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    },
    plugins: {
      scene: [
        {
          plugin: PhaserMatterCollisionPlugin, // The plugin class
          key: "matterCollision", // Where to store in Scene.Systems, e.g. scene.sys.matterCollision
          mapping: "matterCollision" // Where to store in the Scene, e.g. scene.matterCollision
        }
      ]
    }
};

var game = new Phaser.Game(config);

var player1;
var player2;
var wheel1;
var wheel2;


var car1Speed = 0;
var car2Speed = 0;
var staticFriction = 0;

function preload() {
    this.load.image('car', 'assets/car-yellow.png');
    this.load.image('grass', 'assets/grass.jpg');
    this.load.image('wheel', 'assets/steering-wheel.png');
    this.load.image('wall', 'assets/platform.png');
    this.load.image('street', 'assets/street.jpg');
    this.load.image('badge', 'assets/badge.png');
}

function create() {
    cursors = this.input.keyboard.createCursorKeys();

    wasd = this.input.keyboard.addKeys(
      {
        up:Phaser.Input.Keyboard.KeyCodes.W,
        down:Phaser.Input.Keyboard.KeyCodes.S,
        left:Phaser.Input.Keyboard.KeyCodes.A,
        right:Phaser.Input.Keyboard.KeyCodes.D
      }
    );

    // this.add.tileSprite(500, 500, 1000, 1000, 'street').setScale(1);

    var wall1 = this.matter.add.image(275, 275, 'grass', 'grassy', { isStatic: true })
    var wall2 = this.matter.add.image(725, 725, 'grass', 'grassy', { isStatic: true })
    var wall3 = this.matter.add.image(275, 725, 'grass', 'grassy', { isStatic: true })
    var wall4 = this.matter.add.image(725, 275, 'grass', 'grassy', { isStatic: true })

    player1 = this.matter.add.image(500, 500, 'car').setScale(0.3);
    player1.setTint(0xFF5715)

    player2 = this.matter.add.image(510, 500, 'car').setScale(0.3);
    player2.setTint(0x00FF00)

    this.matter.world.setBounds().disableGravity();

    wheel1 = this.add.image(275, 275, 'wheel', { isStatic: true });
    wheel1.setTint(0xFF5715)

    wheel2 = this.add.image(725, 275, 'wheel', { isStatic: true });
    wheel2.setTint(0x00FF00)

    var target = this.matter.add.image(50, 50, 'badge').setScale(0.03);

    this.matterCollision.addOnCollideStart({
      objectA: target,
      objectB: [player1, player2],
      callback: eventData => {
        console.log(`${eventData.gameObjectB} hit target`)
        eventData.gameObjectA.setRandomPosition()
      }
    });
}

function update() {
    if (cursors.left.isDown && wheel1.rotation > -1.5) {
        wheel1.rotation -= 0.1;
    }

    if (cursors.right.isDown && wheel1.rotation < 1.5) {
        wheel1.rotation += 0.1;
    }

    if (cursors.left.isUp && cursors.right.isUp && wheel1.rotation != 0) {
        wheel1.rotation = wheel1.rotation / 1.5;
    }

    if (cursors.up.isDown && car1Speed < 6) {
        car1Speed = car1Speed + (Math.abs(car1Speed) * 0.02) + 0.01;
    }

    if (cursors.down.isDown) {
        car1Speed -= 0.04;
    }


    var speedsquared1 = (player1.body.velocity.x * player1.body.velocity.x) + (player1.body.velocity.y * player1.body.velocity.y);

    //if we have enough power, allow movement
    if (speedsquared1 > staticFriction) {
        player1.setAngularVelocity(wheel1.rotation * 0.05 * Math.exp(-speedsquared1 / 100));
    }

    //no drift
    player1.setVelocityX(Math.sin(player1.rotation)*car1Speed);
    player1.setVelocityY(-Math.cos(player1.rotation)*car1Speed);

    //////////////////////////////////////////////////////////

    if (wasd.left.isDown && wheel2.rotation > -1.5) {
        wheel2.rotation -= 0.1;
    }

    if (wasd.right.isDown && wheel2.rotation < 1.5) {
        wheel2.rotation += 0.1;
    }

    if (wasd.left.isUp && wasd.right.isUp && wheel2.rotation != 0) {
        wheel2.rotation = wheel2.rotation / 1.5;
    }

    if (wasd.up.isDown && car2Speed < 6) {
        car2Speed = car2Speed + (Math.abs(car2Speed) * 0.02) + 0.01;
    }

    if (wasd.down.isDown) {
        car2Speed -= 0.04;
    }


    var speedsquared2 = (player2.body.velocity.x * player2.body.velocity.x) + (player2.body.velocity.y * player2.body.velocity.y);

    //if we have enough power, allow movement
    if (speedsquared2 > staticFriction) {
        player2.setAngularVelocity(wheel2.rotation * 0.05 * Math.exp(-speedsquared2 / 100));
    }

    //no drift
    player2.setVelocityX(Math.sin(player2.rotation)*car2Speed);
    player2.setVelocityY(-Math.cos(player2.rotation)*car2Speed);
}

</script>

</body>
</html>
